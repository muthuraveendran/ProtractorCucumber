{"version":3,"file":"step_runner.js","sourceRoot":"","sources":["../../src/runtime/step_runner.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAA,oDAAsB;AACtB,uDAA8B;AAC9B,gDAAsD;AACtD,2EAAgD;AAChD,iDAA6C;AAC7C,yEAAkD;AAGlD,oDAIyB;AAEzB,MAAM,EAAE,WAAW,EAAE,SAAS,EAAE,GAAG,cAAI,CAAA;AAUhC,KAAK,UAAU,GAAG,CAAC,EACxB,cAAc,EACd,aAAa,EACb,IAAI,EACJ,cAAc,EACd,KAAK,GACO;IACZ,WAAW,EAAE,CAAA;IACb,IAAI,KAAU,EACZ,MAAiD,EACjD,cAA0C,CAAA;IAE5C,IAAI;QACF,cAAc,GAAG,MAAM,cAAc,CAAC,uBAAuB,CAAC;YAC5D,aAAa;YACb,IAAI;YACJ,KAAK;SACN,CAAC,CAAA;KACH;IAAC,OAAO,GAAG,EAAE;QACZ,KAAK,GAAG,GAAG,CAAA;KACZ;IAED,IAAI,gCAAgB,CAAC,KAAK,CAAC,EAAE;QAC3B,MAAM,qBAAqB,GAAG,8BAAc,CAC1C,cAAc,CAAC,OAAO,CAAC,OAAO,EAC9B,cAAc,CACf,CAAA;QAED,IACE,gBAAC,CAAC,QAAQ,CAAC,cAAc,CAAC,gBAAgB,EAAE,cAAc,CAAC,IAAI,CAAC,MAAM,CAAC,EACvE;YACA,MAAM,IAAI,GAAG,MAAM,0BAAc,CAAC,GAAG,CAAC;gBACpC,SAAS,EAAE,cAAc,CAAC,UAAU;gBACpC,EAAE,EAAE,cAAc,CAAC,IAAI;gBACvB,OAAO,EAAE,KAAK;gBACd,qBAAqB;aACtB,CAAC,CAAA;YACF,KAAK,GAAG,IAAI,CAAC,KAAK,CAAA;YAClB,MAAM,GAAG,IAAI,CAAC,MAAM,CAAA;SACrB;aAAM;YACL,KAAK,GAAG,cAAc,CAAC,2BAA2B,EAAE,CAAA;SACrD;KACF;IAED,MAAM,cAAc,GAAG,mBAAQ,CAAC,gBAAgB,CAAC,cAAc,CAAC,UAAU,CAAC;QACzE,QAAQ,EAAE,6BAAsB,CAAC,SAAS,EAAE,CAAC;KAC9C,CAAC,CAAA;IAEF,IAAI,MAAM,KAAK,SAAS,EAAE;QACxB,cAAc,CAAC,MAAM,GAAG,gBAAM,CAAC,OAAO,CAAA;KACvC;SAAM,IAAI,MAAM,KAAK,SAAS,EAAE;QAC/B,cAAc,CAAC,MAAM,GAAG,gBAAM,CAAC,OAAO,CAAA;KACvC;SAAM,IAAI,6BAAa,CAAC,KAAK,CAAC,EAAE;QAC/B,cAAc,CAAC,OAAO,GAAG,kCAAM,CAAC,KAAK,CAAC,CAAA;QACtC,cAAc,CAAC,MAAM,GAAG,gBAAM,CAAC,MAAM,CAAA;KACtC;SAAM;QACL,cAAc,CAAC,MAAM,GAAG,gBAAM,CAAC,MAAM,CAAA;KACtC;IAED,OAAO,cAAc,CAAA;AACvB,CAAC;AA5DD,kBA4DC;AAED,kBAAe,EAAE,GAAG,EAAE,CAAA","sourcesContent":["import _ from 'lodash'\nimport Status from '../status'\nimport Time, { millisecondsToDuration } from '../time'\nimport UserCodeRunner from '../user_code_runner'\nimport { messages } from '@cucumber/messages'\nimport { format } from 'assertion-error-formatter'\nimport { ITestCaseHookParameter } from '../support_code_library_builder/types'\nimport { IDefinition, IGetInvocationDataResponse } from '../models/definition'\nimport {\n  doesHaveValue,\n  doesNotHaveValue,\n  valueOrDefault,\n} from '../value_checker'\n\nconst { beginTiming, endTiming } = Time\n\nexport interface IRunOptions {\n  defaultTimeout: number\n  hookParameter: ITestCaseHookParameter\n  step: messages.Pickle.IPickleStep\n  stepDefinition: IDefinition\n  world: any\n}\n\nexport async function run({\n  defaultTimeout,\n  hookParameter,\n  step,\n  stepDefinition,\n  world,\n}: IRunOptions): Promise<messages.TestStepFinished.ITestStepResult> {\n  beginTiming()\n  let error: any,\n    result: messages.TestStepFinished.ITestStepResult,\n    invocationData: IGetInvocationDataResponse\n\n  try {\n    invocationData = await stepDefinition.getInvocationParameters({\n      hookParameter,\n      step,\n      world,\n    })\n  } catch (err) {\n    error = err\n  }\n\n  if (doesNotHaveValue(error)) {\n    const timeoutInMilliseconds = valueOrDefault(\n      stepDefinition.options.timeout,\n      defaultTimeout\n    )\n\n    if (\n      _.includes(invocationData.validCodeLengths, stepDefinition.code.length)\n    ) {\n      const data = await UserCodeRunner.run({\n        argsArray: invocationData.parameters,\n        fn: stepDefinition.code,\n        thisArg: world,\n        timeoutInMilliseconds,\n      })\n      error = data.error\n      result = data.result\n    } else {\n      error = invocationData.getInvalidCodeLengthMessage()\n    }\n  }\n\n  const testStepResult = messages.TestStepFinished.TestStepResult.fromObject({\n    duration: millisecondsToDuration(endTiming()),\n  })\n\n  if (result === 'skipped') {\n    testStepResult.status = Status.SKIPPED\n  } else if (result === 'pending') {\n    testStepResult.status = Status.PENDING\n  } else if (doesHaveValue(error)) {\n    testStepResult.message = format(error)\n    testStepResult.status = Status.FAILED\n  } else {\n    testStepResult.status = Status.PASSED\n  }\n\n  return testStepResult\n}\n\nexport default { run }\n"]}