{"version":3,"file":"event_data_collector.js","sourceRoot":"","sources":["../../../src/formatter/helpers/event_data_collector.ts"],"names":[],"mappings":"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","sourcesContent":["import _, { Dictionary, values } from 'lodash'\nimport { messages } from '@cucumber/messages'\nimport { doesHaveValue, doesNotHaveValue } from '../../value_checker'\nimport { EventEmitter } from 'events'\nimport { Query } from '@cucumber/query'\n\ninterface ITestCaseAttemptData {\n  attempt: number\n  testCaseId: string\n  stepAttachments: Dictionary<messages.IAttachment[]>\n  stepResults: Dictionary<messages.TestStepFinished.ITestStepResult>\n  worstTestStepResult: messages.TestStepFinished.ITestStepResult\n}\n\nexport interface ITestCaseAttempt {\n  attempt: number\n  gherkinDocument: messages.IGherkinDocument\n  pickle: messages.IPickle\n  stepAttachments: Dictionary<messages.IAttachment[]>\n  stepResults: Dictionary<messages.TestStepFinished.ITestStepResult>\n  testCase: messages.ITestCase\n  worstTestStepResult: messages.TestStepFinished.ITestStepResult\n}\n\nexport default class EventDataCollector {\n  private gherkinDocumentMap: Dictionary<messages.IGherkinDocument> = {}\n  private pickleMap: Dictionary<messages.IPickle> = {}\n  private testCaseMap: Dictionary<messages.ITestCase> = {}\n  private testCaseAttemptDataMap: Dictionary<ITestCaseAttemptData> = {}\n  readonly undefinedParameterTypes: messages.IUndefinedParameterType[] = []\n  readonly query = new Query()\n\n  constructor(eventBroadcaster: EventEmitter) {\n    eventBroadcaster.on('envelope', this.parseEnvelope.bind(this))\n  }\n\n  getGherkinDocument(uri: string): messages.IGherkinDocument {\n    return this.gherkinDocumentMap[uri]\n  }\n\n  getPickle(pickleId: string): messages.IPickle {\n    return this.pickleMap[pickleId]\n  }\n\n  getTestCaseAttempts(): ITestCaseAttempt[] {\n    return _.keys(this.testCaseAttemptDataMap).map((testCaseStartedId) => {\n      return this.getTestCaseAttempt(testCaseStartedId)\n    })\n  }\n\n  getTestCaseAttempt(testCaseStartedId: string): ITestCaseAttempt {\n    const testCaseAttemptData = this.testCaseAttemptDataMap[testCaseStartedId]\n    const testCase = this.testCaseMap[testCaseAttemptData.testCaseId]\n    const pickle = this.pickleMap[testCase.pickleId]\n    return {\n      gherkinDocument: this.gherkinDocumentMap[pickle.uri],\n      pickle,\n      testCase,\n      attempt: testCaseAttemptData.attempt,\n      stepAttachments: testCaseAttemptData.stepAttachments,\n      stepResults: testCaseAttemptData.stepResults,\n      worstTestStepResult: testCaseAttemptData.worstTestStepResult,\n    }\n  }\n\n  parseEnvelope(envelope: messages.Envelope): void {\n    this.query.update(envelope)\n    if (doesHaveValue(envelope.gherkinDocument)) {\n      this.gherkinDocumentMap[envelope.gherkinDocument.uri] =\n        envelope.gherkinDocument\n    } else if (doesHaveValue(envelope.pickle)) {\n      this.pickleMap[envelope.pickle.id] = envelope.pickle\n    } else if (doesHaveValue(envelope.undefinedParameterType)) {\n      this.undefinedParameterTypes.push(envelope.undefinedParameterType)\n    } else if (doesHaveValue(envelope.testCase)) {\n      this.testCaseMap[envelope.testCase.id] = envelope.testCase\n    } else if (doesHaveValue(envelope.testCaseStarted)) {\n      this.initTestCaseAttempt(envelope.testCaseStarted)\n    } else if (doesHaveValue(envelope.attachment)) {\n      this.storeAttachment(envelope.attachment)\n    } else if (doesHaveValue(envelope.testStepFinished)) {\n      this.storeTestStepResult(envelope.testStepFinished)\n    } else if (doesHaveValue(envelope.testCaseFinished)) {\n      this.storeTestCaseResult(envelope.testCaseFinished)\n    }\n  }\n\n  initTestCaseAttempt(testCaseStarted: messages.ITestCaseStarted): void {\n    this.testCaseAttemptDataMap[testCaseStarted.id] = {\n      attempt: testCaseStarted.attempt,\n      testCaseId: testCaseStarted.testCaseId,\n      stepAttachments: {},\n      stepResults: {},\n      worstTestStepResult: {},\n    }\n  }\n\n  storeAttachment({\n    testCaseStartedId,\n    testStepId,\n    body,\n    mediaType,\n  }: messages.IAttachment): void {\n    if (doesHaveValue(testCaseStartedId) && doesHaveValue(testStepId)) {\n      const { stepAttachments } = this.testCaseAttemptDataMap[testCaseStartedId]\n      if (doesNotHaveValue(stepAttachments[testStepId])) {\n        stepAttachments[testStepId] = []\n      }\n      stepAttachments[testStepId].push({ body, mediaType })\n    }\n  }\n\n  storeTestStepResult({\n    testCaseStartedId,\n    testStepId,\n    testStepResult,\n  }: messages.ITestStepFinished): void {\n    this.testCaseAttemptDataMap[testCaseStartedId].stepResults[\n      testStepId\n    ] = testStepResult\n  }\n\n  storeTestCaseResult({ testCaseStartedId }: messages.ITestCaseFinished): void {\n    const stepResults = values(\n      this.testCaseAttemptDataMap[testCaseStartedId].stepResults\n    )\n    this.testCaseAttemptDataMap[\n      testCaseStartedId\n    ].worstTestStepResult = this.query.getWorstTestStepResult(stepResults)\n  }\n}\n"]}